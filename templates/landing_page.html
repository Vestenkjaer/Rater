<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RATER Dashboard</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/rater.ico') }}">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #F5F5F7;
    }

    .navbar {
      background-color: #007AFF;
      color: white;
    }

    .navbar-brand {
      font-family: "San Francisco", sans-serif;
      font-size: 36px;
      color: white;
    }

    .navbar-nav .nav-item .nav-link {
      color: white;
      font-size: 18px;
      border: 1px solid white;
      border-radius: 8px;
      margin-left: 10px;
    }

    .navbar-nav .nav-item .nav-link:hover {
      color: #D1D1D6;
    }

    .user-info {
      color: white;
      font-size: 18px;
      text-align: center;
      margin: 0 auto;
    }

    .button-container {
      text-align: center;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn-custom {
      background-color: #007AFF;
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 12px;
    }

    .btn-custom:hover {
      background-color: #005BB5;
    }

    .latest-submission {
      position: absolute;
      top: 100px;
      right: 20px;
      text-align: right;
      font-size: 16px;
      color: #333;
    }

    .charts-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-top: 20px;
      align-items: center; /* Align items vertically */
    }

    .chart {
      width: 45%;
      margin-bottom: 20px;
    }

    .chart canvas {
      width: 100% !important;
      height: auto !important;
    }

    .chart-title {
      font-family: "San Francisco", sans-serif;
      font-size: 24px;
      color: #333;
      text-align: center;
      margin-bottom: 10px;
    }

    .metrics-container {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
      align-items: center; /* Align items vertically */
    }

    .metric-card {
      width: 22%;
      text-align: center;
      margin-bottom: 20px;
    }

    .circular-progress {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 0 auto;
    }

    .circular-progress svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }

    .circular-progress .circle-bg {
      fill: none;
      stroke: #eee;
      stroke-width: 3.8;
    }

    .circular-progress .circle {
      fill: none;
      stroke-width: 2.8;
      stroke-linecap: round;
      stroke: #007AFF;
      stroke-dasharray: 0, 100;
    }

    .circular-progress text {
      font-size: 6px;
      fill: #333;
      text-anchor: middle;
      transform: rotate(90deg) translate(0, -100%);
    }

    .performance-lists {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }

    .performance-list {
      width: 45%;
    }

    .performance-list h3 {
      font-family: "San Francisco", sans-serif;
      font-size: 24px;
      color: #333;
      text-align: center;
      margin-bottom: 10px;
    }

    .performance-list ul {
      list-style: none;
      padding: 0;
      font-size: 18px;
    }

    .performance-list li {
      background-color: #fff;
      margin: 5px 0;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .dropdown-custom {
      display: inline-block;
      margin-left: 10px;
    }

    .dropdown-custom .btn-custom {
      margin: 0;
      padding: 15px 20px;
    }

    .congratulation-container {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      margin-top: 20px;
    }

    .congratulation-container img {
      width: 50px; /* Adjust the size as needed */
      margin: 0 5px;
    }

    .highlighted {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      text-align: center;
    }

    .popup h3 {
      margin-bottom: 20px;
    }

    .popup button {
      background-color: #007AFF;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      cursor: pointer;
      border-radius: 12px;
    }

    .popup button:hover {
      background-color: #005BB5;
    }

    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="#">RATER - Empowering teams with Data-Driven Insights</a>
    <div class="user-info" id="user-info">
      <!-- User information will be inserted here -->
    </div>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link btn-custom" id="teamManagementButton" href="/team_management">Team Management</a>
        </li>
        <li class="nav-item">
          <a class="nav-link btn-custom" id="setupButton" href="#">Setup</a>
        </li>
        <li class="nav-item">
          <a class="nav-link btn-custom" href="/logout">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="button-container">
    <a href="/rate_team" class="btn btn-custom" id="rateTeamButton">Rate Your Team</a>
    <div class="dropdown-custom" id="selectTeamContainer">
      <a class="btn-custom dropdown-toggle" href="#" id="teamDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Select Team
      </a>
      <div class="dropdown-menu" aria-labelledby="teamDropdown" id="teamDropdownMenu">
      </div>
    </div>
  </div>

  <div class="latest-submission" id="latestSubmissionContainer">
    <!-- Latest submission details will be inserted here -->
  </div>

  <div class="performance-lists">
    <div class="performance-list">
      <h3>Top Performers (Latest)</h3>
      <ul id="topPerformersList"></ul>
    </div>
    <div class="performance-list">
      <h3>Bottom Performers (Latest)</h3>
      <ul id="bottomPerformersList"></ul>
    </div>
  </div>

  <div class="metrics-container">
    <div class="metric-card">
      <h3>Team Average Rating</h3>
      <div class="circular-progress" id="teamAverageProgress">
        <svg viewBox="0 0 36 36">
          <path class="circle-bg" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle" id="teamAverageFill" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <text x="18" y="20.35" font-size="6" transform="rotate(90, 18, 20) translate(0, -100%)" id="teamAverageLabel">0 / 10</text>
        </svg>
      </div>
    </div>
    <div class="metric-card">
      <h3>Team Average Total Score</h3>
      <div class="circular-progress" id="averageTeamTotalScoreProgress">
        <svg viewBox="0 0 36 36">
          <path class="circle-bg" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle" id="averageTeamTotalScoreFill" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <text x="18" y="20.35" font-size="6" transform="rotate(90, 18, 20) translate(0, -100%)" id="averageTeamTotalScoreLabel">0 / 80</text>
        </svg>
      </div>
    </div>
    <div class="metric-card">
      <h3>Highest Individual Score</h3>
      <div class="circular-progress" id="highestIndividualRatingProgress">
        <svg viewBox="0 0 36 36">
          <path class="circle-bg" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle" id="highestIndividualRatingFill" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <text x="18" y="20.35" font-size="6" transform="rotate(90, 18, 20) translate(0, -100%)" id="highestIndividualRatingLabel">0 / 80</text>
        </svg>
      </div>
    </div>
    <div class="metric-card">
      <h3>Lowest Individual Score</h3>
      <div class="circular-progress" id="lowestIndividualRatingProgress">
        <svg viewBox="0 0 36 36">
          <path class="circle-bg" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <path class="circle" id="lowestIndividualRatingFill" d="M18 2.0845
              a 15.9155 15.9155 0 0 1 0 31.831
              a 15.9155 15.9155 0 0 1 0 -31.831" />
          <text x="18" y="20.35" font-size="6" transform="rotate(90, 18, 20) translate(0, -100%)" id="lowestIndividualRatingLabel">0 / 80</text>
        </svg>
      </div>
    </div>
    <div class="congratulation-container" id="congratulationContainer">
      <!-- Congratulatory message and images will be inserted here -->
    </div>
  </div>

  <div class="charts-container">
    <div class="chart">
      <div class="chart-title">Top Performers (Latest)</div>
      <canvas id="topPerformersChart"></canvas>
    </div>
    <div class="chart">
      <div class="chart-title">Bottom Performers (Latest)</div>
      <canvas id="bottomPerformersChart"></canvas>
    </div>
  </div>

  <div id="popupOverlay" class="popup-overlay" style="display: none;"></div>
  <div id="popup" class="popup" style="display: none;">
    <h3 id="popupTitle">New to Raterware? Fear not!</h3>
    <p id="popupMessage">Start creating your team by clicking the Team Management button.</p>
    <button id="popupButton" onclick="closePopup()">Got it!</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let topPerformersChart;
    let bottomPerformersChart;
    let isAdmin = false; // Initialize isAdmin as false
    let tier = 0; // Initialize tier as 0

    $(document).ready(function () {
        fetchTeams().then(data => {
            const teams = data.teams;
            tier = data.tier;
            isAdmin = data.is_admin; // Set isAdmin based on the fetched data
            setupButtonHandler(tier, isAdmin); // Pass the tier and isAdmin to the handler

            if (teams.length > 0) {
                if (teams.length === 1) {
                    // Hide the "Select Team" button and center the "Rate Your Team" button
                    $('#selectTeamContainer').hide();
                    $('#rateTeamButton').css('margin', '0 auto');
                }
                selectTeam(teams[0].id); // Automatically select the first team
                fetchLatestSubmission(teams[0].id);
            } else {
                showPopup("New to Raterware? Fear not!", "Start creating your team by clicking the Team Management button.");
                highlightTeamManagementButton();
            }
        });
        fetchUserInfo(); // Fetch and display user info
    });

    async function fetchTeams() {
        try {
            const response = await fetch('/team_management/get_teams');
            if (response.ok) {
                const data = await response.json();
                const teamDropdownMenu = document.getElementById('teamDropdownMenu');
                teamDropdownMenu.innerHTML = '';
                data.teams.forEach(team => {
                    const a = document.createElement('a');
                    a.className = 'dropdown-item';
                    a.href = '#';
                    a.textContent = team.name;
                    a.onclick = () => {
                        selectTeam(team.id);
                        fetchLatestSubmission(team.id);
                    };
                    teamDropdownMenu.appendChild(a);
                });
                return data;
            } else {
                console.error('Failed to fetch teams');
                return { teams: [], tier: 0, is_admin: false };
            }
        } catch (error) {
            console.error('Error fetching teams:', error);
            return { teams: [], tier: 0, is_admin: false };
        }
    }

    async function fetchLatestSubmission(teamId) {
        try {
            const response = await fetch(`/rate_team/get_last_submission/${teamId}`);
            if (response.ok) {
                const data = await response.json();
                if (data.date) {
                    document.getElementById('latestSubmissionContainer').innerHTML = `Latest submission: <strong>${data.date}</strong>`;
                } else {
                    document.getElementById('latestSubmissionContainer').innerHTML = 'No submissions found';
                    showPopup("Rate Your Team Now", "No ratings found. Click on 'Rate Your Team' to start the evaluation.");
                    highlightRateTeamButton();
                }
            } else {
                console.error('Failed to fetch latest submission');
            }
        } catch (error) {
            console.error('Error fetching latest submission:', error);
        }
    }

    async function selectTeam(teamId) {
        console.log(`Selected team ID: ${teamId}`);
        try {
            const response = await fetch(`/rate_team/get_team_members/${teamId}`);
            if (response.ok) {
                const result = await response.json();
                console.log('Team members:', result.members);
                const members = result.members;
                const sortedMembers = members.sort((a, b) => b.total_score - a.total_score);

                const topPerformers = sortedMembers.slice(0, 3);
                const bottomPerformers = sortedMembers.slice(-3).reverse();

                console.log('Top Performers:', topPerformers);
                console.log('Bottom Performers:', bottomPerformers);

                updatePerformanceList('topPerformersList', topPerformers);
                updatePerformanceList('bottomPerformersList', bottomPerformers);

                updateTeamAverageRadialBar(members);
                updateAverageTeamTotalScoreRadialBar(members);
                updateHighestIndividualRatingRadialBar(members);
                updateLowestIndividualRatingRadialBar(members);

                await updateLineChart('topPerformersChart', 'Top Performers', topPerformers, ['#009B7C', '#007AFF', '#9C007E']);
                await updateLineChart('bottomPerformersChart', 'Bottom Performers', bottomPerformers, ['#F8D164', '#FF6B5C', '#004295']);
            } else {
                console.error('Failed to fetch team members');
            }
        } catch (error) {
            console.error('Error fetching team members:', error);
        }
    }

    function updatePerformanceList(listId, members) {
        const list = document.getElementById(listId);
        list.innerHTML = '';
        members.forEach(member => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${member.first_name} ${member.surname}</span>: Total Score: ${member.total_score}, Average Score: ${member.avg_score.toFixed(2)}`;
            list.appendChild(li);
        });
    }

    function updateTeamAverageRadialBar(members) {
        const totalAvgScoreSum = members.reduce((sum, member) => sum + member.avg_score, 0);
        const teamAverage = (totalAvgScoreSum / members.length).toFixed(2);

        updateCircularProgressBar('teamAverageFill', teamAverage / 10); // Normalize to 0-1 range
        document.getElementById('teamAverageLabel').innerHTML = `${teamAverage} / 10`;
    }

    function updateAverageTeamTotalScoreRadialBar(members) {
        const totalScoreSum = members.reduce((sum, member) => sum + member.total_score, 0);
        const averageTeamTotalScore = (totalScoreSum / members.length).toFixed(1);

        updateCircularProgressBar('averageTeamTotalScoreFill', averageTeamTotalScore / 80); // Normalize to 0-1 range
        document.getElementById('averageTeamTotalScoreLabel').innerHTML = `${averageTeamTotalScore} / 80`;

        // Check if averageTeamTotalScore is 70.1 or higher and display congratulatory message
        if (averageTeamTotalScore >= 71.0) {
            const congratulationMessage = document.getElementById('congratulationContainer');
            congratulationMessage.innerHTML = `
              <p>Congratulations! You have a High Performance Team!</p>
              <div class="congratulation-images">
                <img src="{{ url_for('static', filename='images/star.png') }}" alt="Medal 1">
                <img src="{{ url_for('static', filename='images/star.png') }}" alt="Medal 2">
                <img src="{{ url_for('static', filename='images/star.png') }}" alt="Medal 3">
              </div>
            `;
        } else {
            document.getElementById('congratulationContainer').innerHTML = '';
        }
    }

    function updateHighestIndividualRatingRadialBar(members) {
        const highestScore = Math.max(...members.map(member => member.total_score));

        updateCircularProgressBar('highestIndividualRatingFill', highestScore / 80); // Normalize to 0-1 range
        document.getElementById('highestIndividualRatingLabel').innerHTML = `${highestScore} / 80`;
    }

    function updateLowestIndividualRatingRadialBar(members) {
        const lowestScore = Math.min(...members.map(member => member.total_score));

        updateCircularProgressBar('lowestIndividualRatingFill', lowestScore / 80); // Normalize to 0-1 range
        document.getElementById('lowestIndividualRatingLabel').innerHTML = `${lowestScore} / 80`;
    }

    function updateCircularProgressBar(elementId, value) {
        const progressElement = document.getElementById(elementId);
        const percentage = value * 100; // Convert value to percentage out of 100
        progressElement.style.strokeDasharray = `${percentage}, 100`;
    }

    async function updateLineChart(chartId, label, members, colors) {
        const ctx = document.getElementById(chartId).getContext('2d');

        const datasets = await Promise.all(members.map(async (member, index) => {
            const historicalData = await fetchMemberHistoricalData(member.id);
            member.historical_data = historicalData;

            if (historicalData.length === 0) {
                console.warn(`No historical data for member ${member.first_name} ${member.surname}`);
                return null;
            }

            const last12Data = historicalData.slice(-12).reverse(); // Reverse the order for recent data first
            const scores = last12Data.map(entry => entry.score);

            return {
                label: `${member.first_name} ${member.surname}`,
                data: scores,
                fill: false,
                borderColor: colors[index],
                tension: 0.4,
                pointRadius: 0 // Remove the circles at the data points
            };
        })).then(results => results.filter(dataset => dataset !== null));

        console.log(`Updating chart ${chartId} with datasets:`, datasets);

        const chartData = {
            labels: Array.from({ length: 12 }, (_, i) => `Session ${12 - i}`), // Inverted session labels
            datasets: datasets
        };

        const options = {
            scales: {
                x: {
                    type: 'category',
                    title: {
                        display: true,
                        text: 'Rating Session'
                    },
                    ticks: {
                        autoSkip: false,
                        maxTicksLimit: 12,
                        reverse: true // Invert the x-axis
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: false,
                    min: 30,
                    suggestedMax: 85,
                    ticks: {
                        stepSize: 5
                    },
                    title: {
                        display: true,
                        text: 'Score'
                    }
                }
            }
        };

        if (chartId === 'topPerformersChart') {
            if (topPerformersChart) {
                topPerformersChart.destroy();
            }
            topPerformersChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: options
            });
        } else if (chartId === 'bottomPerformersChart') {
            if (bottomPerformersChart) {
                bottomPerformersChart.destroy();
            }
            bottomPerformersChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: options
            });
        }
    }

    async function fetchMemberHistoricalData(memberId) {
        console.log(`Fetching historical data for member ID: ${memberId}`);
        const response = await fetch(`/rate_team/get_historical_data/${memberId}`);
        if (!response.ok) {
            console.error(`Failed to fetch historical data for member ID: ${memberId}`);
            return [];
        }
        const data = await response.json();
        console.log(`Historical data for member ID ${memberId}:`, data);
        return data;
    }

    async function fetchUserInfo() {
        try {
            const response = await fetch('/user_info');
            if (response.ok) {
                const userInfo = await response.json();
                const userInfoDiv = document.getElementById('user-info');
                userInfoDiv.innerHTML = `Logged in as: ${userInfo.name} (${userInfo.email})`;
                isAdmin = userInfo.is_admin; // Store the is_admin value
                tier = userInfo.tier; // Store the tier value
                setupButtonHandler(tier, isAdmin); // Update the setup button handler based on user info
            } else {
                console.error('Failed to fetch user info');
            }
        } catch (error) {
            console.error('Error fetching user info:', error);
        }
    }

    function setupButtonHandler(tier, isAdmin) {
        const setupButton = document.getElementById('setupButton');
        setupButton.addEventListener('click', (event) => {
            if (!isAdmin) {
                event.preventDefault();
                showPopup(
                    "Access Denied",
                    "You do not have administrative privileges to access the setup page."
                );
            } else if (tier < 2) {
                event.preventDefault();
                showPopup(
                    "To get the full experience of Raterware, please upgrade to the Professional version",
                    "",
                    "/pricing"
                );
            } else {
                window.location.href = "/setup";
            }
        });
    }

    function showPopup(title, message, redirectUrl) {
        document.getElementById('popupTitle').innerText = title;
        document.getElementById('popupMessage').innerText = message;
        document.getElementById('popupOverlay').style.display = 'block';
        document.getElementById('popup').style.display = 'block';
        document.getElementById('popupButton').onclick = () => {
            closePopup();
            if (redirectUrl) {
                window.location.href = redirectUrl;
            }
        };
    }

    function closePopup() {
        document.getElementById('popupOverlay').style.display = 'none';
        document.getElementById('popup').style.display = 'none';
    }

    function highlightTeamManagementButton() {
        const teamManagementButton = document.getElementById('teamManagementButton');
        teamManagementButton.classList.add('highlighted');
    }

    function highlightRateTeamButton() {
        const rateTeamButton = document.getElementById('rateTeamButton');
        rateTeamButton.classList.add('highlighted');
    }
  </script>
</body>
</html>
